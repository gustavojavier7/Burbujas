<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Monitor de Cotizaciones y Liquidaciones Forzosas</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f0f0f0;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .ticker-container {
      overflow: hidden;
      width: 100%;
      white-space: nowrap;
      background-color: #fff;
      color: #000;
      padding: 10px 0;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      margin-bottom: 20px;
    }

    .ticker-content {
      display: inline-flex;
      flex-wrap: nowrap;
      white-space: nowrap;
      will-change: transform;
    }

    .ticker-item {
      display: inline-block;
      padding: 0 20px;
      font-size: 1.2em;
    }

    .ticker-item span {
      margin-right: 10px;
    }

    .liquidation-box {
      width: 90%;
      max-width: 800px;
      height: 300px;
      background-color: #222;
      color: #fff;
      padding: 10px;
      overflow: hidden;
      position: relative;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.5);
    }

    .liquidation-content {
      position: absolute;
      bottom: 0;
      width: 100%;
      display: flex;
      flex-direction: column;
    }

    .liquidation-item {
      font-size: 1em;
      padding: 5px 0;
      border-bottom: 1px solid #444;
      display: flex;
      justify-content: space-between;
    }

    .liquidation-item span {
      display: inline-block;
      padding: 0 10px;
    }

    #top-liquidated h2 {
      margin-top: 0;
    }

    #top-liquidated div {
      font-size: 1em;
    }
  </style>
</head>
<body>
  <div class="ticker-container">
    <div class="ticker-content" id="ticker">
      <!-- El contenido del ticker se llenará con JavaScript -->
    </div>
  </div>

  <div class="liquidation-box">
    <div class="liquidation-content" id="liquidation-content">
      <!-- Las liquidaciones se llenarán aquí con JavaScript -->
    </div>
  </div>

  <!-- El contenedor para el Top 3 se creará dinámicamente -->

  <script>
    const TICKER_24HR_URL = "https://api.binance.com/api/v3/ticker/24hr";
    const SPOT_TICKER_URL = "https://api.binance.com/api/v3/ticker/price?symbol=BTCUSDT";
    const FUTURES_TICKER_URL = "https://fapi.binance.com/fapi/v1/ticker/price?symbol=BTCUSDT";
    const INDEX_PRICE_URL = "https://fapi.binance.com/fapi/v1/premiumIndex?symbol=BTCUSDT";
    const MAX_LIQUIDATIONS = 30;
    const MAX_LIQUIDATIONS_MEMORY = 100;

    let tickerContent = document.getElementById("ticker");
    let tickerPosition = 0;
    const tickerSpeed = 0.5;
    let tickerInitialized = false;
    let liquidations = [];
    let liquidationFrequency = {};

    function startTicker() {
      function scrollTicker() {
        tickerPosition -= tickerSpeed;
        if (tickerPosition <= -tickerContent.scrollWidth / 2) {
          tickerPosition = 0;
        }
        tickerContent.style.transform = `translateX(${tickerPosition}px)`;
        requestAnimationFrame(scrollTicker);
      }
      scrollTicker();
    }

    async function updateTicker() {
      try {
        const [tickerResponse, spotResponse, futuresResponse, indexResponse] = await Promise.all([
          fetch(TICKER_24HR_URL),
          fetch(SPOT_TICKER_URL),
          fetch(FUTURES_TICKER_URL),
          fetch(INDEX_PRICE_URL)
        ]);

        const tickerData = await tickerResponse.json();
        const spotData = await spotResponse.json();
        const futuresData = await futuresResponse.json();
        const indexData = await indexResponse.json();

        const newItems = [];

        const prices = [
          { label: 'SPOT BTCUSDT', price: parseFloat(spotData.price).toFixed(2) },
          { label: 'FUTURES BTCUSDT', price: parseFloat(futuresData.price).toFixed(2) },
          { label: 'INDEX PRICE', price: parseFloat(indexData.markPrice).toFixed(2) },
          { label: 'ESTIMATED SETTLEMENT PRICE', price: parseFloat(indexData.estimatedSettlePrice).toFixed(2) }
        ];

        prices.forEach(item => {
          const tickerItem = createTickerItem(item.label, `$${item.price}`);
          newItems.push(tickerItem);
        });

        await addTop3ToTicker(newItems);

        const allItems = [...newItems, ...newItems.map(item => item.cloneNode(true))];

        tickerContent.innerHTML = '';
        allItems.forEach(item => tickerContent.appendChild(item));

        if (!tickerInitialized) {
          tickerInitialized = true;
        } else if (tickerPosition <= -tickerContent.scrollWidth / 2) {
          tickerPosition = 0;
        }

      } catch (error) {
        console.error("Error al obtener los datos del ticker:", error);
      }
    }

    async function addTop3ToTicker(newItems) {
      const topLiquidated = Object.keys(liquidationFrequency)
        .sort((a, b) => liquidationFrequency[b].count - liquidationFrequency[a].count)
        .slice(0, 3);

      const ticker24HrData = await fetch(TICKER_24HR_URL).then(response => response.json());

      // Añadir el encabezado "TOP 3 MOST LIQ"
      const headerItem = createTickerItem("TOP 3 MOST LIQ", undefined, undefined, "#FFD700");
      newItems.push(headerItem);

      topLiquidated.forEach(symbol => {
        const pairData = ticker24HrData.find(data => data.symbol === symbol);
        if (pairData) {
          const price = parseFloat(pairData.lastPrice).toFixed(2);
          const change = parseFloat(pairData.priceChangePercent).toFixed(2);
          const changeColor = change >= 0 ? '#4CAF50' : '#FF5252';

          const tickerItem = createTickerItem(
            symbol,
            `$${price}`,
            `${change}%`,
            changeColor
          );
          newItems.push(tickerItem);
        }
      });
    }

    function createTickerItem(label, price, change, color) {
      const tickerItem = document.createElement('div');
      tickerItem.className = 'ticker-item';
      tickerItem.style.color = color || 'inherit';

      const labelSpan = document.createElement('span');
      labelSpan.textContent = label;
      tickerItem.appendChild(labelSpan);

      if (price !== undefined) {
        const priceSpan = document.createElement('span');
        priceSpan.textContent = price;
        tickerItem.appendChild(priceSpan);
      }

      if (change !== undefined) {
        const changeSpan = document.createElement('span');
        changeSpan.textContent = change;
        changeSpan.style.color = color;
        tickerItem.appendChild(changeSpan);
      }

      return tickerItem;
    }

    function connectLiquidationWebSocket() {
      const liquidationContent = document.getElementById('liquidation-content');
      const ws = new WebSocket('wss://fstream.binance.com/ws/!forceOrder@arr');

      ws.onmessage = function(event) {
        const data = JSON.parse(event.data);
        const liquidation = data.o;

        if (liquidation) {
          const newLiquidation = {
            symbol: liquidation.s,
            price: liquidation.p,
            quantity: liquidation.q,
            side: liquidation.S
          };

          liquidations.push(newLiquidation);

          if (liquidations.length > MAX_LIQUIDATIONS_MEMORY) {
            liquidations.shift();
          }

          liquidationFrequency[newLiquidation.symbol] = liquidationFrequency[newLiquidation.symbol] || { count: 0, total: 0 };
          liquidationFrequency[newLiquidation.symbol].count++;
          liquidationFrequency[newLiquidation.symbol].total += parseFloat(newLiquidation.price);

          showTopLiquidatedCoins();

          liquidationContent.innerHTML = '';

          liquidations.slice(-MAX_LIQUIDATIONS).forEach(liquidation => {
            const item = document.createElement('div');
            item.className = 'liquidation-item';

            const symbolSpan = document.createElement('span');
            symbolSpan.textContent = `Símbolo: ${liquidation.symbol}`;

            const priceSpan = document.createElement('span');
            priceSpan.textContent = `Precio: ${liquidation.price}`;

            const quantitySpan = document.createElement('span');
            quantitySpan.textContent = `Cantidad: ${liquidation.quantity}`;

            const liquidationColor = liquidation.side === 'SELL' ? '#FF5252' : '#4CAF50';
            item.style.color = liquidationColor;

            item.appendChild(symbolSpan);
            item.appendChild(priceSpan);
            item.appendChild(quantitySpan);

            liquidationContent.appendChild(item);
          });
        } else {
          console.error("Datos inesperados:", data);
        }
      };

      ws.onclose = function() {
        console.error("Conexión de WebSocket cerrada, reconectando...");
        setTimeout(connectLiquidationWebSocket, 1000);
      };

      ws.onerror = function(error) {
        console.error("Error en WebSocket:", error);
      };
    }

    function showTopLiquidatedCoins() {
      const topLiquidated = Object.entries(liquidationFrequency)
        .sort((a, b) => b[1].count - a[1].count)
        .slice(0, 3);

      let topContainer = document.getElementById('top-liquidated');
      if (!topContainer) {
        topContainer = document.createElement('div');
        topContainer.id = 'top-liquidated';
        topContainer.style.width = '90%';
        topContainer.style.maxWidth = '800px';
        topContainer.style.backgroundColor = '#fff';
        topContainer.style.color = '#000';
        topContainer.style.padding = '10px';
        topContainer.style.marginTop = '20px';
        topContainer.style.borderRadius = '10px';
        topContainer.style.boxShadow = '0 2px 5px rgba(0,0,0,0.5)';
        document.body.appendChild(topContainer);
      }

      topContainer.innerHTML = '<h2>Top 3 Monedas Más Liquidadas</h2>';

      topLiquidated.forEach(([symbol, data]) => {
        const item = document.createElement('div');
        item.style.display = 'flex';
        item.style.justifyContent = 'space-between';
        item.style.padding = '5px 0';
        item.style.borderBottom = '1px solid #ccc';

        const symbolSpan = document.createElement('span');
        symbolSpan.textContent = `Símbolo: ${symbol}`;

        const countSpan = document.createElement('span');
        countSpan.textContent = `Liquidaciones: ${data.count}`;

        const averagePrice = (data.total / data.count).toFixed(2);
        const avgPriceSpan = document.createElement('span');
        avgPriceSpan.textContent = `Precio Promedio: $${averagePrice}`;

        item.appendChild(symbolSpan);
        item.appendChild(countSpan);
        item.appendChild(avgPriceSpan);

        topContainer.appendChild(item);
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      updateTicker().then(() => {
        startTicker();
      });
      setInterval(updateTicker, 60000);
      connectLiquidationWebSocket();
    });
  </script>
</body>
</html>
